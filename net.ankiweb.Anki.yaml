app-id: net.ankiweb.Anki

runtime: org.kde.Platform
runtime-version: '5.14'
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable

base: io.qt.qtwebengine.BaseApp
base-version: '5.14'

command: anki
rename-desktop-file: anki.desktop
rename-icon: anki

build-options:
  append-path: /usr/lib/sdk/rust-stable/bin

finish-args:
  # X11/Wayland
  - --socket=x11
  - --share=ipc
  - --socket=wayland
  - --device=dri
  # Flashcards with sound
  - --socket=pulseaudio
  # Sync
  - --share=network
  # Allow other instances to see lockfiles
  - --env=TMPDIR=/var/tmp

modules:
  - name: maturin
    buildsystem: simple
    build-commands:
      - cargo --offline fetch --manifest-path Cargo.toml --verbose
      - cargo --offline build --release --locked --all-features
      - install -Dm755 -t /app/bin/ target/release/maturin
    build-options:
      env:
        - CARGO_HOME=/run/build/maturin/cargo
    sources:
      - type: archive
        url: https://github.com/PyO3/maturin/archive/v0.8.1.tar.gz
        sha256: b72a9885cda3ba4e53906a43aab101acb790622218ade6405b2ddf1ef1461f8f
      - maturin-sources.json

  - name: sip
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix="${FLATPAK_DEST}" --root=/ --optimize=1
    sources:
      - type: archive
        url: https://pypi.python.org/packages/source/s/sip/sip-5.2.0.tar.gz
        sha256: 3d3f279a61d54d832b12496409811ee062dab1ac05a1e7b40824f63b423fb0e7
    cleanup:
      - /bin
      - /include
    modules:
      - python3-toml.json
      - python3-packaging.json

  - name: PyQt5_sip
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix="${FLATPAK_DEST}" --root=/ --optimize=1
    sources:
      - type: archive
        url: https://pypi.python.org/packages/source/P/PyQt5_sip/PyQt5_sip-12.7.2.tar.gz
        sha256: 16a19b9f36985b8bff30b89fb8859d831713dd528fba5600563e36ff077960a2

  - python3-pyqt-builder.json

  - name: pyqt5
    buildsystem: simple
    build-options:
      arch:
        x86_64:
          env:
            - ANKI_BINDINGS=--enable=QtCore --enable=QtGui --enable=QtNetwork --enable=QtPrintSupport --enable=QtWebChannel --enable=QtWidgets
      env:
        - QMAKEPATH=/app/lib
    build-commands:
      - sip-install
        --verbose
        --build-dir ${FLATPAK_BUILDER_BUILDDIR}/build
        --target-dir ${FLATPAK_DEST}/lib/python$(python3 -c 'import sys; print(sys.version[:3])')/site-packages
        $ANKI_BINDINGS
        --confirm-license
        --qt-share
        --no-designer-plugin
        --no-qml-plugin
        --no-dbus-python
        --no-tools
        --qmake-setting QMAKE_CFLAGS_RELEASE="$CFLAGS"
        --qmake-setting QMAKE_CXXFLAGS_RELEASE="$CXXFLAGS"
        --qmake-setting QMAKE_LFLAGS_RELEASE="$LDFLAGS"
        --concatenate 1
        --debug
        --no-docstrings
    sources:
      - type: archive
        url: https://pypi.python.org/packages/source/P/PyQt5/PyQt5-5.14.2.tar.gz
        sha256: bd230c6fd699eabf1ceb51e13a8b79b74c00a80272c622427b80141a22269eb0
    cleanup:
      - /share/sip

  - name: pyqt5-webengine
    buildsystem: simple
    build-options:
      env:
        - QMAKEPATH=/app/lib
    build-commands:
      - sip-install
        --verbose
        --build-dir ${FLATPAK_BUILDER_BUILDDIR}/build
        --target-dir ${FLATPAK_DEST}/lib/python$(python3 -c 'import sys; print(sys.version[:3])')/site-packages
        --qmake-setting QMAKE_CFLAGS_RELEASE="$CFLAGS"
        --qmake-setting QMAKE_CXXFLAGS_RELEASE="$CXXFLAGS"
        --qmake-setting QMAKE_LFLAGS_RELEASE="$LDFLAGS"
        --qmake-setting QMAKE_INCDIR+=/app/include/QtWebEngine
        --qmake-setting QMAKE_INCDIR+=/app/include/QtWebEngineCore
        --qmake-setting QMAKE_INCDIR+=/app/include/QtWebEngineWidgets
        --concatenate 1
        --debug
        --no-docstrings
    sources:
      - type: archive
        url: https://pypi.python.org/packages/source/P/PyQtWebEngine/PyQtWebEngine-5.14.0.tar.gz
        sha256: e11595051f8bfbfa49175d899b2c8c2eea3a3deac4141edf4db68c3555221c92

  - name: mpv
    buildsystem: simple
    build-commands:
      - python3 waf configure
          --disable-alsa
          --disable-build-date
          --disable-libass
          --disable-manpage-build
          --disable-oss-audio
          --prefix=/app
      - python3 waf build
      - python3 waf install
    sources:
      - type: archive
        url: https://github.com/mpv-player/mpv/archive/v0.29.1.tar.gz
        sha256: f9f9d461d1990f9728660b4ccb0e8cb5dce29ccaa6af567bec481b79291ca623
      - type: file
        url: https://waf.io/waf-2.0.15
        sha256: 34b8156ea375089e1bed5a31acfaff4024f6f3e96f3bee98f801f0c281ad3d2c
        dest-filename: waf
    cleanup:
      - /include
      - /lib/pkgconfig
      - /share

  - name: portaudio
    config-opts:
      - --disable-static
      - --without-oss
    sources:
      - type: archive
        url: http://www.portaudio.com/archives/pa_stable_v190600_20161030.tgz
        sha256: f5a21d7dcd6ee84397446fa1fa1a0675bb2e8a4a6dceb4305a8404698d8d1513
    cleanup:
      - /lib/pkgconfig
      - /include
      - '*.la'

  - python3-beautifulsoup4.json
  - python3-send2trash.json
  - python3-pyaudio.json
  - python3-requests.json
  - python3-decorator.json
  - python3-markdown.json
  - python3-distro.json

  # jsonschema has is a PITA to install
  # https://github.com/pypa/pip/issues/5268
  # https://stackoverflow.com/questions/26664102/why-can-i-not-create-a-wheel-in-python
  - python3-wheel.json
  - python3-attrs.json
  - python3-setuptools_scm.json
  - python3-jsonschema.json
  - python3-mypy-protobuf.json


  - name: anki
    buildsystem: simple
    build-commands:
      - echo flatpak > meta/buildhash
      - make -C rspy build
      - make -C pylib build
      - make -C qt build
    make-install-args:
      - PREFIX=/app
    post-install:
      - install -Dm644 -t /app/share/icons/hicolor/scalable/apps anki.svg
      - install -Dm644 -t /app/share/metainfo net.ankiweb.Anki.appdata.xml
      - install -Dm644 anki.xml /app/share/mime/packages/net.ankiweb.Anki.xml
      # .mo files are in a non-standard directory, work-around that,
      # so that Flatpak and Appstream can find the files
      - mv /app/share/anki/locale /app/share/locale
      - ln -s /app/share/locale /app/share/anki/locale
    sources:
      - type: archive
        url: https://github.com/ankitects/anki/archive/2.1.26.tar.gz
        sha256: f5a0c41f3eebe0e77de9d46f2a5cbbe20f7c3a4787f0f02e1d33f298428acbdf
      - type: archive
        url: https://github.com/ankitects/anki-core-i18n/archive/8d6ec08.tar.gz
        sha256: 697ba7987673e8d70d9ae0ffe36bd6fa3b9ed3a0906f99460f14429730ce7892
        dest: rslib/ftl/repo
      - type: archive
        url: https://github.com/ankitects/anki-desktop-ftl/archive/04f26f2.tar.gz
        sha256: 37fc9af8383f770554714474289576601497c2d62cdb17a6115c17d7559df9e0
        dest: qt/ftl/repo
      - type: archive
        url: https://github.com/ankitects/anki-desktop-i18n/archive/0c64190.tar.gz
        sha256: 6d86619e75e49d4d8da07133140c72aae9dad364ecbaa85f836fd89ad8f5b446
        dest: qt/po/repo
      - type: file
        path: anki.svg
      - type: file
        path: net.ankiweb.Anki.appdata.xml
      - type: patch
        paths:
          - patches/0001-Move-aqt_data-to-sys.prefix-share.patch
          - patches/0002-Remove-bad-build-steps-from-makefiles.patch
          - patches/0003-Compile-.py-s-before-building-wheel.patch
          - patches/0004-Disable-auto-updates.patch
    cleanup:
      - /share/pixmaps
